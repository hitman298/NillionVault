<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NillionVault - Secure Document Storage</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: #6c757d;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav-links a:hover {
            color: #2c3e50;
        }

        .main {
            padding: 3rem 0;
        }

        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.1rem;
            color: #6c757d;
            max-width: 600px;
            margin: 0 auto;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: #fff;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }

        .section {
            background: #fff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        .section-description {
            color: #6c757d;
            margin-bottom: 1.5rem;
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .upload-area:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-area.dragover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .upload-subtext {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .file-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            display: none;
            border-left: 4px solid #007bff;
        }

        .file-info.show {
            display: block;
        }

        .file-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .file-size {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }

        .buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 8px;
            display: block;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .result-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.5rem 0;
        }

        .result-label {
            font-weight: 600;
            color: #495057;
        }

        .result-value {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: rgba(0,0,0,0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            flex: 1;
            margin-left: 1rem;
            word-break: break-all;
        }

        .copy-btn {
            background: rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.2);
            color: inherit;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: rgba(0,0,0,0.2);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .form-help {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .upload-list {
            list-style: none;
        }

        .upload-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #007bff;
        }

        .upload-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .upload-item-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .upload-item-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-vaulted {
            background: #28a745;
            color: white;
        }

        .status-uploaded {
            background: #007bff;
            color: white;
        }

        .status-error {
            background: #dc3545;
            color: white;
        }

        .upload-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .detail-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            color: #2c3e50;
            word-break: break-all;
        }

        .detail-copy {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
        }

        .detail-copy:hover {
            background: #0056b3;
        }

        .footer {
            background: #2c3e50;
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-top: 4rem;
        }

        .nillion-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 2rem;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .buttons {
                flex-direction: column;
            }

            .nav-links {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Nillion Network Indicator -->
    <div class="nillion-indicator">
        Connected to Nillion Network
    </div>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="#" class="logo">NillionVault</a>
                <nav>
                    <ul class="nav-links">
                        <li><a href="#store">Store Message</a></li>
                        <li><a href="#verify">Verify</a></li>
                        <li><a href="#list">My Messages</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero">
                <h1>NillionVault - Secure Message Storage</h1>
                <p>Store your messages securely on the Nillion Network with military-grade encryption and distributed storage technology.</p>
            </section>

            <!-- Store Message Section -->
            <section class="section" id="store">
                <h2 class="section-title">Store Message</h2>
                <p class="section-description">Securely store your text messages on the Nillion Network with advanced encryption and distributed storage.</p>
                
                <!-- Anchoring Explanation -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                    <h3 style="font-size: 1rem; margin-bottom: 0.75rem; font-weight: 600;">🔗 What is Anchoring?</h3>
                    <div style="font-size: 0.875rem; line-height: 1.6; opacity: 0.95;">
                        <p style="margin-bottom: 0.5rem;"><strong>Anchoring</strong> creates an immutable cryptographic proof that your message existed at a specific time.</p>
                        <ul style="margin: 0.5rem 0; padding-left: 1.25rem;">
                            <li>✅ Your message is hashed (SHA-256) to create a unique fingerprint</li>
                            <li>✅ This hash is stored in NillionDB and optionally on nilChain blockchain</li>
                            <li>✅ Anyone can verify the message hasn't been altered using the proof hash</li>
                            <li>✅ The proof hash acts as your verification key</li>
                        </ul>
                        <p style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.9;"><em>💡 Tip: Save your verification hash - it's the only way to retrieve your encrypted message!</em></p>
                </div>
                </div>
                
                <!-- Text Message Input -->
                <div class="form-group">
                    <label class="form-label" for="textMessage">Enter your message:</label>
                    <textarea class="form-input" id="textMessage" rows="6" placeholder="Enter your message or text here..."></textarea>
                    <div class="form-help">Type any text message or sentence to store securely on Nillion Network</div>
                    <button class="btn btn-primary" id="uploadTextBtn" style="margin-top: 1rem;">Store Message</button>
                </div>

                <div class="progress-bar" id="progressBar" style="display: none;">
                        <div class="progress-fill" id="progressFill"></div>
                </div>

                <div class="result" id="result"></div>
                
                <!-- Bulk Upload Section -->
                <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid #e9ecef;">
                    <h3 style="margin-bottom: 1rem; font-size: 1.25rem;">Bulk Upload</h3>
                    <p style="color: #6c757d; margin-bottom: 1rem;">Upload multiple messages at once (one per line)</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="bulkMessages">Messages (one per line)</label>
                        <textarea class="form-input" id="bulkMessages" rows="8" placeholder="Message 1&#10;Message 2&#10;Message 3&#10;..."></textarea>
                        <div class="form-help">Enter multiple messages, one per line. Each will be stored separately. Maximum 50 messages.</div>
                    </div>
                    <button class="btn btn-secondary" id="uploadBulkBtn">Upload All Messages</button>
                    <div id="bulkResult" style="margin-top: 1rem;"></div>
                </div>
            </section>

            <!-- Verification Section -->
            <section class="section" id="verify">
                <h2 class="section-title">Message Verification</h2>
                <p class="section-description">Verify message authenticity using your private verification hash. This is a secure, private process.</p>
                
                <div class="form-group">
                    <label class="form-label" for="proofHash">Verification Hash</label>
                    <input type="text" class="form-input" id="proofHash" placeholder="Enter your document verification hash">
                    <div class="form-help">Enter your private verification hash to securely verify document authenticity. This hash is private to you.</div>
                </div>
                <button class="btn btn-primary" id="verifyBtn">Verify Document</button>
                <div class="result" id="verifyResult"></div>
            </section>

            <!-- List Messages Section -->
            <section class="section" id="list">
                <h2 class="section-title">My Messages</h2>
                <p class="section-description">View all your stored messages from NillionDB.</p>
                
                <!-- Statistics Section -->
                <div id="messageStats" style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Total Messages</div>
                            <div style="font-size: 1.5rem; font-weight: 600;" id="statTotal">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Total Size</div>
                            <div style="font-size: 1.5rem; font-weight: 600;" id="statSize">0 Bytes</div>
                            </div>
                        <div>
                            <div style="font-size: 0.875rem; opacity: 0.9;">Filtered</div>
                            <div style="font-size: 1.5rem; font-weight: 600;" id="statFiltered">0</div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Section -->
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label class="form-label" for="searchInput">Search Messages</label>
                        <input type="text" class="form-input" id="searchInput" placeholder="Search by filename or content...">
                    </div>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label class="form-label" for="dateFrom">From Date</label>
                            <input type="date" class="form-input" id="dateFrom">
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 150px;">
                            <label class="form-label" for="dateTo">To Date</label>
                            <input type="date" class="form-input" id="dateTo">
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 120px;">
                            <label class="form-label" for="sortBy">Sort By</label>
                            <select class="form-input" id="sortBy">
                                <option value="newest">Newest First</option>
                                <option value="oldest">Oldest First</option>
                                <option value="name">Name (A-Z)</option>
                                <option value="size">Size (Largest)</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" id="clearFiltersBtn" style="height: fit-content;">Clear Filters</button>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-group" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" id="listBtn">Load Messages</button>
                    <button class="btn btn-secondary" id="refreshListBtn" style="display: none;">Refresh</button>
                    <button class="btn btn-secondary" id="exportAllBtn" style="display: none;">Export All</button>
                    <button class="btn btn-secondary" id="exportSelectedBtn" style="display: none;">Export Selected</button>
                </div>
                
                <div id="listResult" style="margin-top: 1.5rem;"></div>
            </section>

        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 NillionVault. Powered by Nillion Network. All rights reserved.</p>
        </div>
    </footer>

    <script>
        class NillionVaultApp {
            constructor() {
                this.allCredentials = []; // Store all loaded credentials
                this.filteredCredentials = []; // Store filtered results
                this.init();
            }

            init() {
                this.setupEventListeners();
                // Hide verification result initially
                const verifyResult = document.getElementById('verifyResult');
                if (verifyResult) {
                    verifyResult.style.display = 'none';
                }
            }

            setupEventListeners() {
                const uploadTextBtn = document.getElementById('uploadTextBtn');
                const verifyBtn = document.getElementById('verifyBtn');
                const listBtn = document.getElementById('listBtn');
                const refreshListBtn = document.getElementById('refreshListBtn');
                const uploadBulkBtn = document.getElementById('uploadBulkBtn');
                const searchInput = document.getElementById('searchInput');
                const dateFrom = document.getElementById('dateFrom');
                const dateTo = document.getElementById('dateTo');
                const sortBy = document.getElementById('sortBy');
                const clearFiltersBtn = document.getElementById('clearFiltersBtn');
                const exportAllBtn = document.getElementById('exportAllBtn');
                const exportSelectedBtn = document.getElementById('exportSelectedBtn');

                uploadTextBtn.addEventListener('click', () => this.uploadTextMessage());
                verifyBtn.addEventListener('click', () => this.verifyDocument());
                listBtn.addEventListener('click', () => this.loadAllMessages());
                refreshListBtn.addEventListener('click', () => this.loadAllMessages());
                uploadBulkBtn.addEventListener('click', () => this.uploadBulkMessages());
                
                // Search and filter listeners
                if (searchInput) {
                    searchInput.addEventListener('input', () => this.applyFilters());
                }
                if (dateFrom) {
                    dateFrom.addEventListener('change', () => this.applyFilters());
                }
                if (dateTo) {
                    dateTo.addEventListener('change', () => this.applyFilters());
                }
                if (sortBy) {
                    sortBy.addEventListener('change', () => this.applyFilters());
                }
                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', () => this.clearFilters());
                }
                if (exportAllBtn) {
                    exportAllBtn.addEventListener('click', () => this.exportAll());
                }
                if (exportSelectedBtn) {
                    exportSelectedBtn.addEventListener('click', () => this.exportSelected());
                }
            }

            async uploadTextMessage() {
                const textMessage = document.getElementById('textMessage').value.trim();
                if (!textMessage) {
                    this.showResult('Please enter some text to upload.', 'error');
                    return;
                }

                const uploadTextBtn = document.getElementById('uploadTextBtn');
                const progressBar = document.getElementById('progressBar');
                const progressFill = document.getElementById('progressFill');

                uploadTextBtn.disabled = true;
                uploadTextBtn.innerHTML = '<div class="spinner"></div> Storing...';
                progressBar.style.display = 'block';
                progressFill.style.width = '0%';
                this.hideResult();

                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    if (progress <= 90) {
                        progressFill.style.width = `${progress}%`;
                    }
                }, 200);

                try {
                    // Create a text file blob from the message
                    const blob = new Blob([textMessage], { type: 'text/plain' });
                    const file = new File([blob], 'message.txt', { type: 'text/plain' });
                    
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('http://localhost:3001/api/credentials/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    clearInterval(progressInterval);
                    progressFill.style.width = '100%';

                    if (response.ok) {
                        setTimeout(() => {
                            this.showUploadResult(data);
                            document.getElementById('textMessage').value = '';
                            progressBar.style.display = 'none';
                            progressFill.style.width = '0%';
                            
                            // Check anchoring status after a delay
                            if (data.proofHash) {
                                setTimeout(() => {
                                    this.checkAnchoringStatus(data.proofHash);
                                }, 2000);
                            }
                        }, 500);
                    } else {
                        this.showResult(`Store Failed: ${data.message || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    clearInterval(progressInterval);
                    this.showResult(`Error: ${error.message}`, 'error');
                } finally {
                uploadTextBtn.disabled = false;
                    uploadTextBtn.innerHTML = 'Store Message';
                }
            }

            showUploadResult(data) {
                const result = document.getElementById('result');
                
                result.innerHTML = `
                    <div class="result-title">Document Secured Successfully</div>
                    <div class="result-detail">
                        <span class="result-label">Security Status:</span>
                        <span class="result-value">${data.status === 'vaulted' ? 'Secured & Verified' : 'Processing'}</span>
                    </div>
                    <div class="result-detail">
                        <span class="result-label">Nillion Network:</span>
                        <span class="result-value">Connected & Active</span>
                    </div>
                    <div class="result-detail">
                        <span class="result-label">Verification Hash:</span>
                        <span class="result-value">${data.proofHash ? data.proofHash.substring(0, 12) + '...' + data.proofHash.substring(data.proofHash.length - 12) : 'N/A'}</span>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${data.proofHash || ''}')">Copy</button>
                    </div>
                    <div class="result-detail">
                        <span class="result-label">Document ID:</span>
                        <span class="result-value">${data.credentialId ? data.credentialId.substring(0, 8) + '...' + data.credentialId.substring(data.credentialId.length - 8) : 'N/A'}</span>
                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${data.credentialId || ''}')">Copy</button>
                    </div>
                    <div class="result-detail">
                        <span class="result-label">Storage Type:</span>
                        <span class="result-value">Nillion SecretVaults</span>
                    </div>
                    <div class="result-detail" id="anchorStatusDetail">
                        <span class="result-label">Blockchain Status:</span>
                        <span class="result-value">Anchoring...</span>
                    </div>
                `;
                result.className = 'result success';
                result.style.display = 'block';
            }

            async checkAnchoringStatus(proofHash) {
                try {
                    // Query the credential to see if it has anchor info
                    const response = await fetch('http://localhost:3001/api/credentials/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ proofHash })
                    });

                    const data = await response.json();
                    
                    if (data.success && data.credential) {
                        // Update anchor status display if available
                        const anchorStatusDetail = document.getElementById('anchorStatusDetail');
                        if (anchorStatusDetail) {
                            const anchorStatus = data.credential.anchorStatus || 'not_anchored';
                            let statusText = 'Not Anchored';
                            let statusColor = '#6c757d';
                            
                            if (anchorStatus === 'verified' || anchorStatus === 'confirmed') {
                                statusText = '✓ Anchored & Verified';
                                statusColor = '#28a745';
                            } else if (anchorStatus === 'pending') {
                                statusText = '⏳ Anchoring...';
                                statusColor = '#ffc107';
                            } else if (anchorStatus === 'failed') {
                                statusText = '✗ Anchoring Failed';
                                statusColor = '#dc3545';
                            }
                            
                            anchorStatusDetail.innerHTML = `
                                <span class="result-label">Anchoring Status:</span>
                                <span class="result-value" style="color: ${statusColor};">${statusText}</span>
                            `;
                        }
                    }
                } catch (error) {
                    // Silently fail - anchoring check is optional
                }
            }

            showResult(message, type) {
                const result = document.getElementById('result');
                result.innerHTML = message;
                result.className = `result ${type}`;
                result.style.display = 'block';
            }

            hideResult() {
                document.getElementById('result').style.display = 'none';
            }


            async verifyDocument() {
                const proofHash = document.getElementById('proofHash').value.trim();
                const verifyResult = document.getElementById('verifyResult');
                const verifyBtn = document.getElementById('verifyBtn');

                if (!proofHash) {
                    verifyResult.innerHTML = '<div class="result error">Please enter a verification hash.</div>';
                    verifyResult.style.display = 'block';
                    return;
                }

                verifyBtn.disabled = true;
                verifyBtn.innerHTML = '<div class="spinner"></div> Verifying...';
                verifyResult.style.display = 'none';

                try {
                    const response = await fetch('http://localhost:3001/api/credentials/verify', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ proofHash })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        if (data.success && data.credential) {
                            const hasContent = data.credential.content && data.credential.content.trim();
                            const contentDisplay = hasContent 
                                ? `<div class="result-detail" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e9ecef;">
                                        <div class="result-label" style="margin-bottom: 0.5rem; font-weight: 600;">Retrieved Message:</div>
                                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; max-height: 300px; overflow-y: auto;">${this.escapeHtml(data.credential.content)}</div>
                                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${this.escapeForJs(data.credential.content)}')" style="margin-top: 0.5rem;">Copy Message</button>
                                   </div>`
                                : '';
                            
                            verifyResult.innerHTML = `
                                <div class="result success">
                                    <div class="result-title">Verification Successful</div>
                                    <div class="result-detail">
                                        <span class="result-label">Credential ID:</span>
                                        <span class="result-value">${data.credential.id.substring(0, 8)}...${data.credential.id.substring(data.credential.id.length - 8)}</span>
                                        <button class="copy-btn" onclick="navigator.clipboard.writeText('${data.credential.id}')">Copy</button>
                                    </div>
                                    <div class="result-detail">
                                        <span class="result-label">File Name:</span>
                                        <span class="result-value">${data.credential.title || data.credential.file_name || 'N/A'}</span>
                                    </div>
                                    <div class="result-detail">
                                        <span class="result-label">Document Status:</span>
                                        <span class="result-value status-${data.credential.status}">${data.credential.status === 'vaulted' ? 'Secured & Verified' : data.credential.status}</span>
                                    </div>
                                    <div class="result-detail">
                                        <span class="result-label">Uploaded At:</span>
                                        <span class="result-value">${new Date(data.credential.created_at).toLocaleString()}</span>
                                    </div>
                                    <div class="result-detail">
                                        <span class="result-label">Network Status:</span>
                                        <span class="result-value">Nillion Network Active</span>
                                    </div>
                                    ${data.credential.anchorStatus ? `
                                    <div class="result-detail">
                                        <span class="result-label">Anchoring Status:</span>
                                        <span class="result-value" style="color: ${data.credential.anchorStatus === 'verified' || data.credential.anchorStatus === 'confirmed' ? '#28a745' : data.credential.anchorStatus === 'pending' ? '#ffc107' : '#6c757d'};">
                                            ${data.credential.anchorStatus === 'verified' || data.credential.anchorStatus === 'confirmed' ? '✓ Anchored & Verified' : 
                                              data.credential.anchorStatus === 'pending' ? '⏳ Pending' : 
                                              data.credential.anchorStatus === 'failed' ? '✗ Failed' : 
                                              'Not Anchored'}
                                        </span>
                                    </div>
                                    ${data.credential.anchorTxHash ? `
                                    <div class="result-detail">
                                        <span class="result-label">Anchor Hash:</span>
                                        <span class="result-value" style="font-family: monospace; font-size: 0.875rem;">${data.credential.anchorTxHash.substring(0, 16)}...${data.credential.anchorTxHash.substring(data.credential.anchorTxHash.length - 16)}</span>
                                    </div>
                                    ` : ''}
                                    ` : ''}
                                    ${contentDisplay}
                                </div>
                            `;
                            verifyResult.style.display = 'block';
                        } else {
                            verifyResult.innerHTML = '<div class="result error">Document with this verification hash not found.</div>';
                            verifyResult.style.display = 'block';
                        }
                    } else {
                        verifyResult.innerHTML = `<div class="result error">Verification Failed: ${data.message || 'Unknown error'}</div>`;
                        verifyResult.style.display = 'block';
                    }
                } catch (error) {
                    verifyResult.innerHTML = `<div class="result error">Error during verification: ${error.message}</div>`;
                    verifyResult.style.display = 'block';
                } finally {
                    verifyBtn.disabled = false;
                    verifyBtn.innerHTML = 'Verify Document';
                }
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            escapeForJs(text) {
                return text.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '\\r');
            }

            async loadAllMessages() {
                const listBtn = document.getElementById('listBtn');
                const refreshListBtn = document.getElementById('refreshListBtn');
                const listResult = document.getElementById('listResult');

                listBtn.disabled = true;
                listBtn.innerHTML = '<div class="spinner"></div> Loading...';
                refreshListBtn.style.display = 'none';
                listResult.innerHTML = '';

                try {
                    const response = await fetch('http://localhost:3001/api/credentials/list?limit=100', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.allCredentials = data.credentials || [];
                        
                        // Update statistics
                        this.updateStatistics(this.allCredentials);
                        
                        // Apply filters and display
                        this.applyFilters();
                        
                        refreshListBtn.style.display = 'inline-flex';
                        const exportAllBtn = document.getElementById('exportAllBtn');
                        const exportSelectedBtn = document.getElementById('exportSelectedBtn');
                        if (exportAllBtn) exportAllBtn.style.display = 'inline-flex';
                        if (exportSelectedBtn) exportSelectedBtn.style.display = 'inline-flex';
                    } else {
                        listResult.innerHTML = `<div class="result error">Failed to load messages: ${data.message || 'Unknown error'}</div>`;
                    }
                } catch (error) {
                    listResult.innerHTML = `<div class="result error">Error loading messages: ${error.message}</div>`;
                } finally {
                    listBtn.disabled = false;
                    listBtn.innerHTML = 'Load Messages';
                }
            }

            updateStatistics(credentials) {
                const total = credentials.length;
                const totalSize = credentials.reduce((sum, cred) => sum + (cred.size_bytes || 0), 0);
                const statsDiv = document.getElementById('messageStats');
                
                if (statsDiv && total > 0) {
                    statsDiv.style.display = 'block';
                    document.getElementById('statTotal').textContent = total;
                    document.getElementById('statSize').textContent = this.formatFileSize(totalSize);
                } else if (statsDiv) {
                    statsDiv.style.display = 'none';
                }
            }

            applyFilters() {
                if (this.allCredentials.length === 0) return;

                const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
                const dateFrom = document.getElementById('dateFrom')?.value || '';
                const dateTo = document.getElementById('dateTo')?.value || '';
                const sortBy = document.getElementById('sortBy')?.value || 'newest';

                // Filter by search term
                let filtered = this.allCredentials.filter(cred => {
                    const matchesSearch = !searchTerm || 
                        (cred.file_name && cred.file_name.toLowerCase().includes(searchTerm)) ||
                        (cred.content && cred.content.toLowerCase().includes(searchTerm)) ||
                        (cred.proof_hash && cred.proof_hash.toLowerCase().includes(searchTerm));

                    if (!matchesSearch) return false;

                    // Filter by date range
                    if (dateFrom || dateTo) {
                        const credDate = new Date(cred.created_at || cred.stored_at);
                        if (dateFrom && credDate < new Date(dateFrom)) return false;
                        if (dateTo) {
                            const toDate = new Date(dateTo);
                            toDate.setHours(23, 59, 59, 999); // Include entire end date
                            if (credDate > toDate) return false;
                        }
                    }

                    return true;
                });

                // Sort
                filtered = [...filtered].sort((a, b) => {
                    switch (sortBy) {
                        case 'oldest':
                            return new Date(a.created_at || a.stored_at) - new Date(b.created_at || b.stored_at);
                        case 'name':
                            return (a.file_name || '').localeCompare(b.file_name || '');
                        case 'size':
                            return (b.size_bytes || 0) - (a.size_bytes || 0);
                        case 'newest':
                        default:
                            return new Date(b.created_at || b.stored_at) - new Date(a.created_at || a.stored_at);
                    }
                });

                this.filteredCredentials = filtered;
                this.updateStatistics(this.allCredentials);
                document.getElementById('statFiltered').textContent = filtered.length;
                this.displayMessages(filtered);
            }

            clearFilters() {
                document.getElementById('searchInput').value = '';
                document.getElementById('dateFrom').value = '';
                document.getElementById('dateTo').value = '';
                document.getElementById('sortBy').value = 'newest';
                this.applyFilters();
            }

            displayMessages(credentials) {
                const listResult = document.getElementById('listResult');
                
                if (credentials.length === 0) {
                    listResult.innerHTML = `
                        <div class="result" style="padding: 2rem; text-align: center; color: #6c757d;">
                            <p>No messages found matching your filters.</p>
                        </div>
                    `;
                    return;
                }

                const messagesHtml = credentials.map((cred, index) => {
                                const hasContent = cred.content && cred.content.trim();
                                const contentPreview = hasContent 
                                    ? (cred.content.length > 100 
                                        ? cred.content.substring(0, 100) + '...' 
                                        : cred.content)
                                    : 'No content available';
                                
                                return `
                                    <div style="background: #fff; border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                            <div style="flex: 1;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                                    <input type="checkbox" class="message-checkbox" data-id="${cred._id}" style="width: 18px; height: 18px; cursor: pointer;">
                                                    <div style="font-weight: 600;">${this.escapeHtml(cred.file_name || 'message.txt')}</div>
                                                </div>
                                                <div style="font-size: 0.875rem; color: #6c757d;">
                                                    ${new Date(cred.created_at || cred.stored_at).toLocaleString()} • ${this.formatFileSize(cred.size_bytes || 0)}
                                                </div>
                                            </div>
                                            <div style="font-size: 0.75rem; color: #6c757d; text-align: right;">
                                                <div>Status: <span style="color: #28a745;">${cred.status || 'vaulted'}</span></div>
                                            </div>
                                        </div>
                                        
                                        ${hasContent ? `
                                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                                            <div style="font-size: 0.875rem; color: #6c757d; margin-bottom: 0.5rem;">Message Preview:</div>
                                            <div style="font-family: 'Courier New', monospace; white-space: pre-wrap; word-wrap: break-word; max-height: 150px; overflow-y: auto;">${this.escapeHtml(contentPreview)}</div>
                                        </div>
                                        ` : ''}
                                        
                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                            <button class="copy-btn" onclick="navigator.clipboard.writeText('${cred.proof_hash}')">Copy Hash</button>
                                            <button class="copy-btn" onclick="document.getElementById('proofHash').value = '${cred.proof_hash}'; document.querySelector('a[href=\\'#verify\\']').click();">Verify This</button>
                                            ${hasContent ? `<button class="copy-btn" onclick="navigator.clipboard.writeText('${this.escapeForJs(cred.content)}')">Copy Message</button>` : ''}
                                            <button class="copy-btn" style="background: #dc3545; color: white;" onclick="app.deleteMessage('${cred._id}', '${this.escapeForJs(cred.file_name || 'message')}')">Delete</button>
                                        </div>
                                        
                                        <div style="margin-top: 0.75rem; font-size: 0.75rem; color: #6c757d; font-family: monospace; word-break: break-all;">
                                            Hash: ${cred.proof_hash.substring(0, 16)}...${cred.proof_hash.substring(cred.proof_hash.length - 16)}
                                        </div>
                                    </div>
                                `;
                            }).join('');

                            listResult.innerHTML = `
                                <div>
                                    ${credentials.length !== this.allCredentials.length ? `
                                    <div style="margin-bottom: 1rem; padding: 0.75rem; background: #fff3cd; border-radius: 4px; color: #856404;">
                                        Showing ${credentials.length} of ${this.allCredentials.length} message${this.allCredentials.length !== 1 ? 's' : ''}
                                    </div>
                                    ` : ''}
                                    ${messagesHtml}
                                </div>
                            `;
            }

            exportAll() {
                const credentials = this.filteredCredentials.length > 0 ? this.filteredCredentials : this.allCredentials;
                this.exportCredentials(credentials, 'all-messages');
            }

            exportSelected() {
                const checkboxes = document.querySelectorAll('.message-checkbox:checked');
                if (checkboxes.length === 0) {
                    alert('Please select at least one message to export.');
                    return;
                }

                const selectedIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
                const selected = this.filteredCredentials.filter(cred => selectedIds.includes(cred._id));
                this.exportCredentials(selected, 'selected-messages');
            }

            exportCredentials(credentials, filename) {
                if (credentials.length === 0) {
                    alert('No messages to export.');
                    return;
                }

                // Create JSON export
                const exportData = {
                    exportDate: new Date().toISOString(),
                    totalMessages: credentials.length,
                    messages: credentials.map(cred => ({
                        id: cred.id || cred.credential_id,
                        proof_hash: cred.proof_hash,
                        file_name: cred.file_name,
                        file_type: cred.file_type,
                        size_bytes: cred.size_bytes,
                        created_at: cred.created_at || cred.stored_at,
                        status: cred.status,
                        content: cred.content || null
                    }))
                };

                // Create and download file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            async deleteMessage(recordId, fileName) {
                if (!confirm(`Are you sure you want to delete "${fileName}"? This action cannot be undone.`)) {
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:3001/api/credentials/${recordId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Show success message
                        const listResult = document.getElementById('listResult');
                        listResult.innerHTML = `
                            <div class="result success" style="margin-bottom: 1rem;">
                                Message deleted successfully!
                            </div>
                        `;
                        
                        // Reload the list after a short delay
                        setTimeout(() => {
                            this.loadAllMessages();
                        }, 500);
                    } else {
                        alert(`Failed to delete message: ${data.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    alert(`Error deleting message: ${error.message}`);
                }
            }

            async uploadBulkMessages() {
                const bulkMessagesText = document.getElementById('bulkMessages').value.trim();
                const bulkResult = document.getElementById('bulkResult');
                const uploadBulkBtn = document.getElementById('uploadBulkBtn');

                if (!bulkMessagesText) {
                    bulkResult.innerHTML = '<div class="result error">Please enter at least one message.</div>';
                    bulkResult.style.display = 'block';
                    return;
                }

                // Split by newlines and filter out empty lines
                const messages = bulkMessagesText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);

                if (messages.length === 0) {
                    bulkResult.innerHTML = '<div class="result error">No valid messages found. Please enter at least one non-empty message.</div>';
                    bulkResult.style.display = 'block';
                    return;
                }

                if (messages.length > 50) {
                    bulkResult.innerHTML = '<div class="result error">Too many messages. Maximum 50 messages at once.</div>';
                    bulkResult.style.display = 'block';
                    return;
                }

                uploadBulkBtn.disabled = true;
                uploadBulkBtn.innerHTML = '<div class="spinner"></div> Uploading...';
                bulkResult.innerHTML = '';
                bulkResult.style.display = 'none';

                const results = {
                    success: [],
                    failed: [],
                    total: messages.length
                };

                // Upload messages one by one (in sequence to avoid overwhelming the server)
                for (let i = 0; i < messages.length; i++) {
                    const message = messages[i];
                    uploadBulkBtn.innerHTML = `<div class="spinner"></div> Uploading ${i + 1}/${messages.length}...`;

                    try {
                        const formData = new FormData();
                        const blob = new Blob([message], { type: 'text/plain' });
                        formData.append('file', blob, `message-${i + 1}.txt`);

                        const response = await fetch('http://localhost:3001/api/credentials/upload', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (response.ok && data.success) {
                            results.success.push({
                                index: i + 1,
                                message: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
                                proofHash: data.proofHash,
                                credentialId: data.credentialId
                            });
                        } else {
                            results.failed.push({
                                index: i + 1,
                                message: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
                                error: data.message || 'Unknown error'
                            });
                        }
                    } catch (error) {
                        results.failed.push({
                            index: i + 1,
                            message: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
                            error: error.message
                        });
                    }

                    // Small delay between uploads to avoid rate limiting
                    if (i < messages.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }

                // Display results
                let resultHtml = `
                    <div class="result ${results.failed.length === 0 ? 'success' : 'warning'}" style="margin-bottom: 1rem;">
                        <div class="result-title">Bulk Upload Complete</div>
                        <div class="result-detail">
                            <span class="result-label">Total:</span>
                            <span class="result-value">${results.total}</span>
                        </div>
                        <div class="result-detail">
                            <span class="result-label">Successful:</span>
                            <span class="result-value" style="color: #28a745;">${results.success.length}</span>
                        </div>
                        <div class="result-detail">
                            <span class="result-label">Failed:</span>
                            <span class="result-value" style="color: #dc3545;">${results.failed.length}</span>
                        </div>
                    </div>
                `;

                if (results.success.length > 0) {
                    resultHtml += `
                        <div style="margin-top: 1rem;">
                            <h4 style="font-size: 1rem; margin-bottom: 0.5rem; color: #28a745;">✓ Successfully Uploaded (${results.success.length})</h4>
                            <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 1rem; border-radius: 4px;">
                                ${results.success.map(item => `
                                    <div style="padding: 0.5rem 0; border-bottom: 1px solid #dee2e6;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Message ${item.index}:</div>
                                        <div style="font-size: 0.875rem; color: #6c757d; margin-bottom: 0.25rem;">${this.escapeHtml(item.message)}</div>
                                        <div style="font-size: 0.75rem; font-family: monospace; color: #007bff; word-break: break-all;">Hash: ${item.proofHash.substring(0, 16)}...${item.proofHash.substring(item.proofHash.length - 16)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                if (results.failed.length > 0) {
                    resultHtml += `
                        <div style="margin-top: 1rem;">
                            <h4 style="font-size: 1rem; margin-bottom: 0.5rem; color: #dc3545;">✗ Failed Uploads (${results.failed.length})</h4>
                            <div style="max-height: 200px; overflow-y: auto; background: #fff3cd; padding: 1rem; border-radius: 4px; border: 1px solid #ffc107;">
                                ${results.failed.map(item => `
                                    <div style="padding: 0.5rem 0; border-bottom: 1px solid #ffc107;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">Message ${item.index}:</div>
                                        <div style="font-size: 0.875rem; color: #6c757d; margin-bottom: 0.25rem;">${this.escapeHtml(item.message)}</div>
                                        <div style="font-size: 0.75rem; color: #dc3545;">Error: ${this.escapeHtml(item.error)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                bulkResult.innerHTML = resultHtml;
                bulkResult.style.display = 'block';

                uploadBulkBtn.disabled = false;
                uploadBulkBtn.innerHTML = 'Upload All Messages';

                // Clear the bulk messages textarea if all succeeded
                if (results.failed.length === 0) {
                    document.getElementById('bulkMessages').value = '';
                }

                // Optionally refresh the message list
                if (results.success.length > 0) {
                    setTimeout(() => {
                        this.loadAllMessages();
                    }, 1000);
                }
            }
        }

        // Initialize the application
        const app = new NillionVaultApp();
    </script>
</body>
</html>